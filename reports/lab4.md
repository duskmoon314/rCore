# lab 4

> 贺鲲鹏 2018011169

## 实现简述

- 加入 `mmap` `munmap` 的系统调用及相关函数
- 为地址范围实现 `is_overlapped` 用于 `is_mapped_area` 检查
- 添加 `translate_writable_va` 用于将可写的虚拟地址转换为物理地址
- 修改 `translated_byte_buffer` 返回 `Result`，在不可读时返回 `Err`
- 修改 `sys_get_time` 使用 `translate_writable_va` 转换后的物理地址进行赋值

## 思考题

### 1

Sv39 页表项：

| 63-54 | 53-28      | 27-19      | 18-10      | 9-8 | 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| ----- | ---------- | ---------- | ---------- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 保留  | 物理页号 2 | 物理页号 1 | 物理页号 0 | RSW | D   | A   | G   | U   | X   | W   | R   | V   |

- V 位决定了该页表项的其余部分是否有效（V = 1 时有效）。若 V = 0，则任何遍历
  到此页表项的虚址转换操作都会导致页错误。
- R、W 和 X 位分别表示此页是否可以读取、写入和执行。如果这三个位都是 0，
  那么这个页表项是指向下一级页表的指针，否则它是页表树的一个叶节点。
- U 位表示该页是否是用户页面。若 U = 0，则 U 模式不能访问此页面，但 S 模式
  可以。若 U = 1，则 U 模式下能访问这个页面，而 S 模式不能。
- G 位表示这个映射是否对所有虚址空间有效，硬件可以用这个信息来提高地址转
  换的性能。这一位通常只用于属于操作系统的页面。
- A 位表示自从上次 A 位被清除以来，该页面是否被访问过。
- D 位表示自从上次清除 D 位以来页面是否被弄脏（例如被写入）。
- RSW 域留给操作系统使用，它会被硬件忽略。
- PPN 域包含物理页号，这是物理地址的一部分。若这个页表项是一个叶节点，那
  么 PPN 是转换后物理地址的一部分。否则 PPN 给出下一节页表的地址。

### 2

缺页可导致 Instruction page fault, Load page fault, Store page fault

考虑委托给 S 模式，发生异常的指令 PC 存入 `sepc`，PC 被置为 `stvec`。同时根据异常类型设置 `scause`，并将 `stval` 设置为出错的地址或其他特定的信息字。`sstatus` 的 `SIE` 置零，屏蔽中断，此前的值保存在 `SPIE` 中，`SPP` 保存发生异常的权限模式，并设置当前模式为 S 模式。

lazy 策略的好处是节约物理内存空间，避免与外存间的频繁 IO 导致效率低下。

10G 连续内存页面需要 2621440 个三级页表，5120 个二级页表项，10 个一级页表项，总共需要约 20MB

程序申请空间时，分配一个 V 项为 0 的页面，并在 RSW 域中选择一个两位二进制数表示是 lazy 的页面。发生缺页异常时检查该域是否有对应标记。如果有 lazy 的标记，则分配物理空间，继续执行。

V 项为 0

### 3

将 `satp` 的 `MODE` 域置为 8（Sv39 分页模式），并将一级页表的基址写入 `PPN`域，并使用 `sfence.vma` 刷新 TLB

将内核页面的 U 项设置为 0

用户态程序和内核切换时不用更换页表，减少切换开销

双页表下，每次用户态和内核态切换都需要更换页表。单页表在用户态程序相互切换时需要更换页表。此外内核初始化进入用户态都需要切换页表。

## 意见

tutorial 和 tests 间有若干小细节需要统一（x

- elf 文件是否有 `.elf` 后缀
